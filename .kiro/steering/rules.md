
# AI開発標準ルールまとめ（rules.md）

## 1. 日本語での応答・ドキュメント・コメント
- AIは日本語で応答すること。
- ドキュメントやコメントも日本語で記述する。
- 英語への自動切り替えは禁止。

## 2. 責務分離の徹底
- 各モジュール・関数は単一の責務を持つこと。
- 守られないことが多いため、レビュー時に重点確認。

## 3. ドキュメントの整合性
- README, CHANGELOG, LICENSE, RELEASENOTE などの必須ドキュメントは常に最新状態に保つ。
- バージョン番号の整合性チェックをリリースワークフローに組み込む。

## 4. Linter関係
- ruff を中心に運用する。可能なチェックと自動修正は ruff に委任する。
- 不足機能のみ別ツールで補う（例：black をフォーマットの最終整形に利用、isort は不要なら無効化）。
- ルールは `pyproject.toml` に一本化し、pre-commit と CI で必ず実行する（ruff, mypy, pytest）。
- ローカル実行例: `ruff check .` / `ruff format .` / `black .`（必要時）。

## 5. Test関係
- テストはpytestを使う。
- テストコードは `tests/` ディレクトリに整理。
- テストコードは `test_` で始まる。
- カバレッジをCIで確認し、最低基準を設ける。
- リリース前に全テストが通過していることを確認。
- precommit hookを使うことで、リリース前に自動整形を行う。

- 段階的厳格化ポリシー:
  - 開発の成熟度に応じてテスト粒度と lint/mypy の厳格度を上げる。例:
    - prototype: 単体テスト中心、mypy 緩和設定
    - staging: 結合テストを追加、mypy レベル引き上げ
    - production: フルカバレッジ目標、mypy strict、セキュリティゲート必須

## 6. ルートフォルダの整理整頓
- 以下のファイルのみルートフォルダに配置する：
  - エントリポイント：`main.py`, `test_entry.py`, `Makefile` など
  - 設定ファイル：`.gitignore`, `.flake8`, `pyproject.toml` など
  - 必須ドキュメント：`README.md`, `CHANGELOG.md`, `LICENSE`, `rules.md`
- その他のファイルは目的に応じて以下に整理：
  - `src/`：実装コード
  - `tests/`：テストコード
  - `docs/`：詳細ドキュメント
  - `playground/`：使用例コード
  - `scripts/`, `tools/`：補助スクリプト
  - `assets/`, `output/`, `.cache/`：素材・生成物

## 7. 古いルールの不使用
- `requirements.txt` や `setup.py` などの旧式構成は基本的には使用しないが、互換性維持の為に自動同期して`requirements.txt`は保持する。
- 代わりに `pyproject.toml` を使用して依存管理・設定を統合する。

## 8. 仮想環境の使用

このプロジェクトでは、プロジェクト共通ルールとして `uv` を仮想環境と依存関係の管理ツールとして採用します。`uv` を使うことで環境作成、依存解決、ロックファイル管理、ツール実行を一貫して行います。以下は採用方針と運用上の注意点です。

- 採用方針（要約）:
  - 開発・ローカル実行・CI における仮想環境と依存管理は原則 `uv` を用いる。
  - グローバルな CLI 管理や一時的なユーティリティ実行は `uv tool` / `uvx` を優先し、必要に応じて `pipx` を使用する。

- インストール（推奨）:
  - 推奨方法（Windows PowerShell）: 公式インストーラを利用する。
    ```powershell
    irm https://astral.sh/uv/install.ps1 | iex
    ```
  - 代替: `pip install uv`（CI の簡便さや制約による）。開発者マシンではスタンドアロンインストーラか `pipx` 経由でのインストールが望ましい。

- 仮想環境の作成と利用（基本ワークフロー）:
  - 新しいプロジェクトや仮想環境が無い場合は `uv venv` を用いて作成する（デフォルトで `.venv` に作成され、`uv` はこれを自動検出します）。
  - Python バージョンを指定して環境を作るには: `uv venv --python 3.13`（必要に応じて `uv python install 3.13` でダウンロード可能）。
  - 依存関係は `pyproject.toml` / プロジェクト設定に従って `uv lock`（ロック生成）と `uv sync`（ローカル環境へ反映）を用いて管理する。

  例（PowerShell）:
  ```powershell
  # カレントディレクトリに .venv を作る
  uv venv
  # 依存をロックしてインストール
  uv lock
  uv sync
  # 仮想環境を明示的に使ってパッケージを追加
  uv pip install requests
  ```

- アクティベーションについて:
  - 多くの `uv` コマンドは環境を自動検出して操作するため、手動で Activate する必要は必ずしもありません。手動で PowerShell 上でアクティベートする場合は：
    ```powershell
    .\.venv\Scripts\Activate.ps1
    ```
  - `uv run script.py` や `uvx <tool>` はアクティベート不要で隔離環境上で実行します。

- `--system` フラグの扱い（重要）:
  - `uv` の `--system` フラグはシステム Python を変更します。開発環境での使用は禁止とし、CI/コンテナ等の特殊環境でしか許可しないことを明記する。

- pipx と `uv` の使い分け:
  - プロジェクト単位の依存管理・実行は `uv` を優先する。
  - ユーザーレベルでグローバルにインストールしておきたいCLIツールは `pipx` を許容するが、CI やプロジェクトで再現可能に動かす必要がある場合は `uv tool install` またはプロジェクトに明示した方法でインストールして実行する。

- ロックファイルと CI 運用（必須）:
  - 各プロジェクトは `uv lock` によるロックファイル（プロジェクトのロックファイル）をコミットし、CI では必ずロックと同期を検証するジョブを持つこと（例：`uv sync --check` 相当の検証を実行）。
  - CI ワークフローは `uv` をインストールし、`uv lock/uv sync` を用いた再現性チェック、さらに脆弱性スキャン（依存監査 / SCA）および秘密情報検出を必須で実行し、重大な問題はビルドをブロックすること。

- 追加の運用ルール:
  - 仮想環境および依存関係に関する重要な変更（Python バージョン、主要パッケージのメジャーアップデートなど）は PR で明示し、必要な場合は Lockfile 更新を伴う。レビュアーは lockfile の差分を確認すること。
  - `uv` を使う際は、`--no-input`/自動化オプションを用いて CI 非対話モードで確実に動作することを確認する。

- 例外と互換性:
  - 既存の特殊ワークフローで `uv` を直ちに導入できない場合は、一時的に従来ツールを併用できるが、移行計画（期限・担当）を定めること。

以上を `仮想環境の使用` に関するプロジェクト共通ルールとします。

## 9. Debug規約
- print関数によるデバッグ出力は禁止。必ずloggingモジュールまたはプロジェクト専用のLoggerを用いること。
- ログレベルは意図に応じてDEBUG, INFO, WARNING, ERRORを使い分けること。
- ruffによるT20xのチェックは必ず行うこと。

## 10. 一時コードの管理
- デバッグ用の一時関数・変数には _debug_ プレフィックスを付与すること。
- 一時コードはPR作成前に必ず削除またはコメント化してレビュー時に明示すること。

## 11. 共通スタイル
- 命名: ファイル・関数・変数は snake_case、クラスは PascalCase、定数は UPPER_SNAKE_CASE。
- PEP8 準拠を基本とする。
- 型: 明示的な型ヒントを付与する。`Any` の使用は例外扱いとし、理由を PR に記載する。CI で mypy を実行する。