# WSLカーネル安定版リリース監視ツール 実装計画書（エキスパート提言反映版）

## 1. プロジェクト概要

Microsoft公式のWSL2 Linuxカーネルリポジトリを監視し、新しい安定版リリースが出たらWindowsトースト通知でお知らせする常駐ツール。

- **対象リポジトリ**: `microsoft/WSL2-Linux-Kernel`
- **通知手段**: Windows 10/11 のトースト通知
- **実行環境**: Windows（Scoop + pipx + uv）
- **開発環境**: VS Code
- **想定ユーザー**: 複数PC・複数WSLディストリビューションで開発しているHiroさん

---

## 2. ゴール

- 新しい安定版カーネルリリースをリアルタイムで検知
- Windowsタスクトレイに常駐し、見逃しを防止
- 通知をクリックすると、WSLでビルド手順を開始できる
- WSLとWindowsの両方で環境差異が発生しないように一元管理

---

## 3. 機能要件

| 機能                 | 必須 | 詳細                                      |
|----------------------|------|-------------------------------------------|
| GitHubリリース監視   | ✅   | GitHub APIで最新安定版リリースを取得      |
| プレリリース除外     | ✅   | RC版・プレビュー版をスキップ              |
| WSLカーネルバージョン取得 | ✅   | `wsl uname -r` で現在のバージョン取得    |
| バージョン比較       | ✅   | 最新リリースと現在のカーネルを比較        |
| Windowsトースト通知  | ✅   | 更新があればポップアップ表示              |
| タスクトレイ常駐     | ✅   | 常駐アプリとして起動し、定期チェック      |
| 通知クリックアクション | オプション | ビルドスクリプトをWSLで起動           |
| 設定ファイル         | オプション | チェック間隔・リポジトリURLを設定可能   |
| 自動アップデート     | 後回し | Scoopで更新可能にするか検討              |

---

## 4. 技術選定（エキスパート提言反映）

| 目的             | 推奨ライブラリ           | 理由・備考                                 |
|------------------|-------------------------|--------------------------------------------|
| GitHubリリース取得 | requests + urllib3.Retry | レート制限・リトライ戦略で安定運用         |
| 常駐・トレイ管理 | pystray または psgtray   | GUI統合ならpsgtray（PySimpleGUI連携）      |
| トースト通知     | Windows-Toasts           | WinRTベースでWindows 10/11対応・安定       |
| スケジューリング | APScheduler または Rocketry | ジョブ永続化・堅牢性                       |
| 設定管理         | toml                     | pyproject.tomlと統一性                     |
| 仮想環境         | pipx + uv                | グローバルpip禁止でクリーン管理            |
| 配布             | scoop (オプション)        | 複数PCでのインストール統一                 |

---

## 5. 処理フロー

### 5.1 初回起動

1. 設定ファイル `config.toml` を読み込み
2. GitHub APIで最新安定版リリース取得（リトライ・レート制限考慮）
3. WSL内で現在のカーネルバージョンを取得（堅牢なエラーハンドリング）
4. バージョン比較
5. 結果を通知

### 5.2 定期チェック

1. バックグラウンドで N分おきにGitHub APIにアクセス（永続ジョブ）
2. 新しい安定版が出たら：
    - トースト通知
    - タスクトレイのアイコンを「更新あり」状態に変更
3. 通知クリック時のアクション：
    - オプションでWSLビルドスクリプトを呼び出す

---

## 6. ディレクトリ構成（推奨）

```
wsl-kernel-watcher/
├── src/
│   ├── __init__.py
│   ├── main.py              # エントリーポイント
│   ├── github_api.py        # APIクライアント
│   ├── notifier.py          # Windows通知
│   ├── tray.py              # タスクトレイ管理
│   ├── wsl_utils.py         # カーネル取得・ビルド
│   └── config.py            # 設定管理
├── config.toml              # 設定ファイル
├── pyproject.toml           # uv管理用
├── README.md
├── requirements.txt
└── tests/                   # テストコード
    ├── test_github_api.py
    ├── test_wsl_utils.py
    └── ...
```

---

## 7. 開発計画（ストーリーポイント方式）

| フェーズ | 推奨タスク内容                                 | SP目安 |
|----------|-----------------------------------------------|--------|
| 1        | GitHub APIクライアント実装（リトライ含む）     | 3SP    |
| 2        | WSLカーネル取得処理（堅牢化）                 | 3SP    |
| 3        | Windows-Toasts通知機能                        | 2SP    |
| 4        | タスクトレイ常駐化＋ミニGUI（psgtray推奨）     | 4SP    |
| 5        | 設定ファイル対応（config.toml）                | 2SP    |
| 6        | Scoopインストーラ対応（任意）                  | 4SP    |
| 7        | テスト自動化（Pytest）＋CI/CD（GitHub Actions）| 8SP    |
| 合計     |                                               | 26SP   |

---

## 8. 品質保証・自動化

- テストコードは `tests/` ディレクトリで管理
- pytestによる自動テスト
- GitHub ActionsによるCI/CD導入
- 変更時のリグレッション防止

---

## 9. ユーザー体験（UX）・拡張性

- 通知のみのシンプル実装も可能だが、ミニGUI（トレイアイコンから「ビルド」ボタン等）推奨
- 最新バージョン・現在のカーネルバージョン表示
- 通知クリックでWSLビルド自動化
- VS Code拡張機能統合（将来的な拡張）
- プレリリース通知や複数PC通知共有は優先度低め

---

## 10. まとめ・推奨事項

- 技術スタックは信頼性・保守性重視で選定
- 工数見積もりはストーリーポイント方式で柔軟に
- テスト・CI/CDは初期段階から導入
- ミニGUI統合でユーザー体験最大化
- 最初は推奨技術スタックでPoC（プロトタイプ）作成・動作検証

---

> 本計画書は、WSLカーネル安定版リリース監視ツールを長期的・プロフェッショナルなツールへ進化させるための戦略的ロードマップです。
> ご質問・ご要望があれば随時フィードバックください。
